# 扫块的测试点

---

### 一、 功能测试

这是最基础的测试，确保扫块程序能准确无误地完成其核心任务。

| 测试类别          | 测试点                                                       | 预期结果                                                     |
| :---------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **基础扫描能力**  | 1. 程序能正常连接到配置的区块链节点（如主网、测试网）。      | 连接成功，能获取到最新区块号。                               |
|                   | 2. 能持续监听并获取到新区块。                                | 新区块产生时，程序能即时捕获并开始处理。                     |
|                   | 3. 能正确获取指定区块的完整详情（含交易列表）。              | 获取的区块数据与区块链浏览器数据一致。                       |
| **事件/交易过滤** | 4. 能正确过滤出特定**合约地址**的交易/事件。                 | 只处理目标地址的数据，忽略无关地址的数据。                   |
|                   | 5. 能正确过滤出特定**事件主题**的日志（如 `Transfer`）。     | 只解析和处理目标事件，忽略其他事件。                         |
|                   | 6. 能正确过滤出特定**函数调用**的交易（通过 `input` 数据）。 | 能准确识别对特定合约函数的调用。                             |
| **数据处理**      | 7. 能正确解析交易收据和日志数据。                            | 解析出的 `from`, `to`, `amount`, 事件参数等与链上数据完全一致。 |
|                   | 8. 能正确处理原生代币转账（如 ETH 转账）。                   | 能识别 `to` 地址和 `value` 值。                              |
|                   | 9. 能正确解码复杂的事件参数（如结构体、数组）。              | 复杂数据被完整、准确地还原。                                 |
| **业务逻辑触发**  | 10. 当扫描到符合条件的交易/事件时，能正确触发预设的业务逻辑（如更新数据库、发送消息）。 | 数据库记录正确更新；消息队列收到正确格式的消息。             |

---

### 二、 异常与边界测试

这类测试确保程序在非理想情况下依然健壮，不会轻易崩溃或丢失数据。

| 测试类别           | 测试点                                                       | 预期结果                                                     |
| :----------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **节点连接异常**   | 1. 节点RPC连接中断。                                         | 程序应检测到连接失败，进入重试逻辑，并记录告警日志。         |
|                    | 2. 节点响应超时。                                            | 程序应有超时设置，并尝试重试或切换备用节点。                 |
|                    | 3. 节点返回错误响应（如 `rate limit`, `internal error`）。   | 程序应能处理错误码，进行指数退避重试。                       |
| **网络与数据异常** | 4. 获取到的区块数据格式异常或不完整。                        | 程序应能捕获解析异常，跳过该区块并告警，而不是崩溃。         |
|                    | 5. 处理到一条符合条件但数据格式非法的交易/日志（例如，参数数量不对）。 | 程序应能捕获异常，记录错误详情并跳过该条数据，继续处理后续数据。 |
| **区块链本身特性** | 6. **链重组**：程序已处理的区块被回滚。                      | 程序应能检测到重组，并触发相应的回滚逻辑（如将已入账的充值标记为无效）。 |
|                    | 7. **孤块**：程序扫描到了最终未被主链采纳的区块。            | 程序应能识别孤块，并忽略其中的所有交易。                     |
| **边界值**         | 8. 扫描一个**空区块**（交易数量为0）。                       | 程序能正常处理，不报错。                                     |
|                    | 9. 扫描一个**超大区块**（交易数量极多，如NFT铸造时）。       | 程序性能在可接受范围内，不因内存溢出而崩溃。                 |
|                    | 10. 处理涉及**合约自毁** 的地址相关交易。                    | 程序能正确处理，不会因地址不存在而报错。                     |

---

### 三、 性能与负载测试

确保扫块程序能满足生产环境下的性能要求。

| 测试类别       | 测试点                                                       | 预期结果                                                     |
| :------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **吞吐量**     | 1. 在链上活动高峰期，程序处理一个区块的**平均耗时**和**最大耗时**。 | 耗时必须小于平均出块时间（如以太坊的12秒），否则会造成积压。 |
|                | 2. 程序每秒能处理多少笔符合条件的交易/事件。                 | 满足业务峰值期的预期。                                       |
| **资源消耗**   | 3. 长时间运行时，程序的**内存占用**是否稳定，是否存在内存泄漏。 | 内存占用平稳，无持续增长趋势。                               |
|                | 4. **CPU** 和 **网络 I/O** 使用率是否在合理范围内。          | 资源使用率正常，不影响服务器上其他服务。                     |
| **并发与压力** | 5. 模拟短时间内产生大量区块（如分叉链同步数据）。            | 程序能正常处理积压的区块，最终追上最新区块，且无数据丢失。   |
|                | 6. RPC节点的请求频率是否触及其速率限制。                     | 程序应有请求限流机制，避免被节点封禁。                       |

---

### 四、 数据一致性与完整性测试

这是金融相关场景的测试核心，确保数据 100% 准确，不重不漏。

| 测试类别     | 测试点                                                       | 预期结果                                                     |
| :----------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **数据补漏** | 1. 程序重启后，能自动检测并补扫**停机期间**遗漏的区块。      | 从上次成功处理的区块号开始，连续处理直到最新区块，所有数据均被正确处理。 |
|              | 2. 手动指定一个历史区块范围，程序能正确扫描并处理。          | 处理结果与从该范围起点开始实时监听的结果完全一致。           |
| **幂等性**   | 3. **重复处理**同一个区块。                                  | 业务逻辑是幂等的，重复处理不会在数据库中产生重复记录或错误的余额。 |
| **顺序性**   | 4. 确保交易/事件是按照**区块号**和**交易索引**的顺序进行处理的。 | 对于依赖顺序的业务（如NFT转账），处理顺序与链上顺序严格一致。 |
| **数据验证** | 5. 将程序扫描并处理后的数据，与区块链浏览器（如 Etherscan）的原始数据进行对比校验。 | 所有关键字段（地址、金额、状态）完全一致。                   |

---

### 五、 安全测试

| 测试类别     | 测试点                                                       | 预期结果                                                     |
| :----------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **访问安全** | 1. RPC连接是否支持 HTTPS/WSS。                               | 使用加密连接，防止通信被窃听或篡改。                         |
|              | 2. 节点API密钥的权限是否为最小权限。                         | 密钥仅具有 `eth_getBlockByNumber`, `eth_getLogs` 等只读权限，无发送交易权限。 |
| **数据安全** | 3. 程序是否会对输入的区块数据（如地址、金额）进行有效性校验和过滤，防止注入攻击。 | 能抵御恶意构造的交易数据对下游业务系统（如数据库）的攻击。   |
| **业务安全** | 4. 尝试发送一笔指向平台热钱包的虚假交易，看程序是否会错误识别。 | 程序能正确验证交易的真实性，不会因伪造的数据而误操作。       |

---

### 六、 配置与部署测试

| 测试类别       | 测试点                                                       | 预期结果                                                   |
| :------------- | :----------------------------------------------------------- | :--------------------------------------------------------- |
| **配置灵活性** | 1. 修改配置（如监听的合约地址、起始区块号、RPC节点URL）后，重启程序生效。 | 程序读取新配置，并按照新配置正确运行。                     |
|                | 2. 配置错误（如无效RPC URL，错误合约地址）时，程序启动失败或给出明确错误信息。 | 有良好的配置校验机制。                                     |
| **高可用部署** | 3. 同时启动多个扫块程序实例，测试是否有互斥锁机制防止重复处理。 | 同一时间只有一个实例在处理特定区块，其他实例处于待命状态。 |
|                | 4. 主动停止主实例，备用实例能自动接管扫描工作。              | 实现高可用，服务不中断。                                   |

### 总结

测试一个扫块程序是一个系统工程，需要模拟各种正常、异常和极端情况。一个可靠的扫块程序必须通过以上所有方面的考验，尤其是在**金融交易**这种对**准确性、实时性和安全性**要求极高的场景下，任何细微的漏洞都可能导致直接的资产损失。建议采用 **自动化测试+人工验证** 相结合的方式，并定期在测试网甚至主网（小额）进行实战演练。